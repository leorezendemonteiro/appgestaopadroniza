<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORRETAGESTAO02 - DRE Simplificado</title>
    <link rel="icon" type="image/jpeg" href="https://i.imgur.com/5faoeha.jpeg">
    <link rel="shortcut icon" href="https://i.imgur.com/5faoeha.jpeg">
    <link rel="apple-touch-icon" href="https://i.imgur.com/5faoeha.jpeg">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para a aba ativa */
        .tab-active {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: #ffffff;
        }
        /* Esconde as abas inativas */
        .tab-content {
            display: none;
        }
        /* Mostra a aba ativa */
        .tab-content-active {
            display: block;
        }
        .admin-tab-content { display: none; }
        .admin-tab-content-active { display: block; }
        /* Estilos para a área de impressão do PDF */
        #pdf-detailed-content {
            font-family: Arial, sans-serif;
            color: #333;
        }
        .pdf-header {
            text-align: center;
            margin-bottom: 1rem;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 9pt;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        .pdf-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .pdf-summary-table {
            width: 100%;
            margin-top: 1rem;
            font-size: 10pt;
        }
         .pdf-summary-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        /* Background for internal screens */
        .app-bg {
            background-image: url('https://i.imgur.com/Jt1yHe8.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* Login background */
        #auth-screen {
            background-image: url('https://i.imgur.com/3IyVc2j.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCqYsuVE3oju_BT_nMDNyws-8QiglgZN-8",
        authDomain: "appgestao-trakto.firebaseapp.com",
        projectId: "appgestao-trakto",
        storageBucket: "appgestao-trakto.appspot.com",
        messagingSenderId: "967772034888",
        appId: "1:967772034888:web:37ac2d26c3092c8413857d"
      };
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      window.auth = firebase.auth();
</script>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">

    <!-- =========== AUTENTICAÇÃO =========== -->
    <div id="auth-screen" class="relative min-h-screen flex items-end justify-center p-4">
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-[350px] bg-white/80 p-6 text-center">
            <div id="login-form-div" class="space-y-4">
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Entrar</button>
                    <p id="login-error" class="text-red-600 text-sm"></p>
                </form>
                <!-- Link e formulário de auto cadastro removidos -->
            </div>
        </div>
    </div>

    <!-- =========== PRIMEIRO ACESSO =========== -->
    <div id="first-access-screen" class="hidden min-h-screen flex items-center justify-center p-4 app-bg">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-xl font-bold mb-4">Definir Nova Senha</h2>
            <form id="first-access-form" class="space-y-4">
                <input type="password" id="first-password" placeholder="Nova senha" class="w-full p-3 border border-slate-300 rounded-lg" required>
                <input type="password" id="first-confirm" placeholder="Confirme a senha" class="w-full p-3 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Salvar</button>
            </form>
        </div>
    </div>

    <!-- =========== TELA DE BOAS-VINDAS =========== -->
    <div id="welcome-screen" class="hidden min-h-screen flex items-center justify-center p-4 app-bg">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg text-center">
            <img src="https://i.imgur.com/5faoeha.jpeg" alt="Logo" class="mx-auto mb-8">
            <h1 class="text-2xl font-bold mb-6 text-slate-700">Bem-vindo ao DRE Simplificado</h1>
            <form id="company-form" class="space-y-4">
                <input type="text" id="company-name" name="name" placeholder="Nome da sua empresa" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <input type="text" id="company-cnpj" name="cnpj" placeholder="CNPJ" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300">
                    Iniciar DRE
                </button>
            </form>
        </div>
    </div>

    <!-- =========== INTERFACE PRINCIPAL DO APP =========== -->
    <div id="main-app" class="hidden app-bg">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
             <div class="flex items-center space-x-3">
                <img src="https://i.imgur.com/5faoeha.jpeg" alt="Logo" id="header-logo" class="h-12">
                <div>
                    <h1 id="header-company-name" class="text-lg font-bold text-slate-800">Nome da Empresa</h1>
                    <p id="header-company-cnpj" class="text-sm text-slate-500">CNPJ</p>
                </div>
            </div>
            <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">Sair</button>
        </header>

        <!-- Navegação das Abas -->
        <nav class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-1 sm:space-x-2 overflow-x-auto -mb-px">
                    <button data-tab="calibracao" class="tab-button tab-active whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Calibração</button>
                    <button data-tab="receitas" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Receitas</button>
                    <button data-tab="despesas-variaveis" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Consumo</button>
                    <button data-tab="despesas-fixas" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Desp. Fixas</button>
                    <button data-tab="mao-de-obra" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Mão de Obra</button>
                    <button data-tab="relatorio" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Relatório</button>
                    <button data-tab="perfil" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Perfil</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Conteúdo da Aba Calibração -->
            <div id="tab-calibracao" class="tab-content tab-content-active">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Calibração de Taxas e Impostos</h2>
                    <form id="calibration-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label for="imposto-faturamento" class="text-sm font-medium">Imposto Faturamento (%)</label>
                            <input type="number" id="imposto-faturamento" name="imposto_faturamento" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 4.5">
                        </div>
                        <div class="space-y-1">
                            <label for="taxa-debito" class="text-sm font-medium">Taxa de Débito (%)</label>
                            <input type="number" id="taxa-debito" name="taxa_debito" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 1.99">
                        </div>
                        <div class="space-y-1">
                            <label for="taxa-credito" class="text-sm font-medium">Taxa de Crédito (%)</label>
                            <input type="number" id="taxa-credito" name="taxa_credito" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 3.49">
                        </div>
                        <div class="space-y-1">
                            <label for="comissao-ifood" class="text-sm font-medium">Comissão iFood (%)</label>
                            <input type="number" id="comissao-ifood" name="comissao_ifood" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 12">
                        </div>
                        <div class="space-y-1">
                            <label for="comissao-99" class="text-sm font-medium">Comissão 99 (%)</label>
                            <input type="number" id="comissao-99" name="comissao_99" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 10">
                        </div>
                         <div class="space-y-1">
                            <label for="encargos-diversos" class="text-sm font-medium">Encargos Diversos (%)</label>
                            <input type="number" id="encargos-diversos" name="encargos_diversos" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 1.5">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Salvar Calibração</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Conteúdo da Aba Receitas -->
            <div id="tab-receitas" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Nova Receita</h2>
                    <form id="receitas-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                             <label for="receita-descricao" class="text-sm font-medium">Descrição</label>
                             <input type="text" id="receita-descricao" name="descricao" placeholder="Ex: Vendas do dia" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                             <label for="receita-tipo" class="text-sm font-medium">Tipo de Pagamento</label>
                             <select id="receita-tipo" name="tipo" class="w-full p-2 border rounded-lg bg-white" required>
                                <option value="Crédito">Crédito</option>
                                <option value="Débito">Débito</option>
                                <option value="Pix">Pix</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="iFood">iFood</option>
                                <option value="99">99</option>
                             </select>
                        </div>
                        <div>
                            <label for="receita-valor" class="text-sm font-medium">Valor (R$)</label>
                            <input type="number" id="receita-valor" name="valor" placeholder="150.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div class="md:col-span-2">
                             <label for="receita-data" class="text-sm font-medium">Data</label>
                             <input type="date" id="receita-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="md:col-span-2">
                             <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Receita</button>
                        </div>
                    </form>
                </div>
                <div id="receitas-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Receitas Salvas</h3>
                    <div class="overflow-x-auto">
                        <!-- Lista de receitas será inserida aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo da Aba Consumo (Despesas Variáveis) -->
            <div id="tab-despesas-variaveis" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Lançamento de Consumo</h2>
                    <form id="despesas-variaveis-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="dv-categoria" class="text-sm font-medium">Categoria</label>
                            <select id="dv-categoria" name="categoria" class="w-full p-2 border rounded-lg bg-white" required>
                                <option>Alimentar</option>
                                <option>Produtos de limpeza e higiene</option>
                                <option>Embalagens e descartáveis</option>
                                <option>Gás</option>
                                <option>Bebidas e similares</option>
                                <option>Outros</option>
                            </select>
                        </div>
                        <div>
                            <label for="dv-descricao" class="text-sm font-medium">Descrição</label>
                            <input type="text" id="dv-descricao" name="descricao" placeholder="Ex: Compra de carnes" class="w-full p-2 border rounded-lg">
                        </div>
                         <div>
                            <label for="dv-valor" class="text-sm font-medium">Valor (R$)</label>
                            <input type="number" id="dv-valor" name="valor" placeholder="350.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div>
                            <label for="dv-data" class="text-sm font-medium">Data</label>
                            <input type="date" id="dv-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="dv-fornecedor" class="text-sm font-medium">Fornecedor</label>
                            <input type="text" id="dv-fornecedor" name="fornecedor" placeholder="Ex: Casa de Carnes ABC" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Lançamento</button>
                        </div>
                    </form>
                </div>
                <div id="despesas-variaveis-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Lançamentos de Consumo Salvos</h3>
                     <div class="overflow-x-auto">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Despesas Fixas -->
            <div id="tab-despesas-fixas" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Despesa Fixa</h2>
                    <form id="despesas-fixas-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="df-categoria" class="text-sm font-medium">Categoria</label>
                            <select id="df-categoria" name="categoria" class="w-full p-2 border rounded-lg bg-white" required>
                                <option>Aluguel</option>
                                <option>IPTU</option>
                                <option>Água</option>
                                <option>Energia elétrica</option>
                                <option>Internet/telefone</option>
                                <option>Mensalidade de software</option>
                                <option>Contabilidade</option>
                                <option>Marketing</option>
                                <option>Parcela de financiamento</option>
                                <option>Prólabore</option>
                            </select>
                        </div>
                        <div>
                            <label for="df-valor" class="text-sm font-medium">Valor (R$)</label>
                            <input type="number" id="df-valor" name="valor" placeholder="1500.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div>
                            <label for="df-data" class="text-sm font-medium">Data</label>
                            <input type="date" id="df-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="df-fornecedor" class="text-sm font-medium">Fornecedor</label>
                            <input type="text" id="df-fornecedor" name="fornecedor" placeholder="Ex: Imobiliária Central" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Despesa Fixa</button>
                        </div>
                    </form>
                </div>
                <div id="despesas-fixas-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Despesas Fixas Salvas</h3>
                     <div class="overflow-x-auto">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Mão de Obra -->
            <div id="tab-mao-de-obra" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Custo de Mão de Obra</h2>
                    <form id="mao-de-obra-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="mo-categoria" class="text-sm font-medium">Categoria</label>
                            <select id="mo-categoria" name="categoria" class="w-full p-2 border rounded-lg bg-white" required>
                                <option>Salários</option>
                                <option>Férias</option>
                                <option>Verbas rescisórias</option>
                                <option>INSS</option>
                                <option>FGTS</option>
                                <option>Vale transporte</option>
                                <option>Vale alimentação</option>
                                <option>Exames periódicos</option>
                                <option>Uniformes</option>
                            </select>
                        </div>
                        <div>
                             <label for="mo-valor" class="text-sm font-medium">Valor (R$)</label>
                             <input type="number" id="mo-valor" name="valor" placeholder="2500.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div>
                             <label for="mo-data" class="text-sm font-medium">Data</label>
                             <input type="date" id="mo-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="mo-fornecedor" class="text-sm font-medium">Fornecedor / Funcionário</label>
                            <input type="text" id="mo-fornecedor" name="fornecedor" placeholder="Ex: Nome do Funcionário" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Mão de Obra</button>
                        </div>
                    </form>
                </div>
                <div id="mao-de-obra-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Custos de Mão de Obra Salvos</h3>
                     <div class="overflow-x-auto">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Relatório -->
            <div id="tab-relatorio" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Gerar Relatório DRE</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="report-type" class="text-sm font-medium">Tipo</label>
                            <select id="report-type" class="w-full p-2 border rounded-lg bg-white">
                                <option value="monthly">Mensal</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                        <div id="month-selector-div">
                            <label for="report-month" class="text-sm font-medium">Mês</label>
                            <input type="month" id="report-month" class="w-full p-2 border rounded-lg">
                        </div>
                        <div id="year-selector-div" class="hidden">
                             <label for="report-year" class="text-sm font-medium">Ano</label>
                             <input type="number" id="report-year" placeholder="2024" class="w-full p-2 border rounded-lg">
                        </div>
                         <div>
                             <button id="generate-report-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Gerar Relatório</button>
                         </div>
                    </div>
                </div>

                <!-- Container para o relatório visível na tela -->
                <div id="report-output" class="mt-6 bg-white p-6 rounded-xl shadow-lg hidden">
                    <!-- Este será o resumo visível na tela -->
                    <div id="report-summary-view">
                        <div class="flex justify-between items-start mb-6 border-b pb-4">
                            <div>
                                <h3 id="report-company-name-view" class="text-2xl font-bold">Nome da Empresa</h3>
                                <p id="report-company-cnpj-view" class="text-slate-600">CNPJ</p>
                            </div>
                            <div class="text-right">
                                <h4 class="font-bold">Relatório DRE</h4>
                                <p id="report-period-view" class="text-slate-600">Período</p>
                                <p id="report-date-view" class="text-sm text-slate-500">Gerado em: DD/MM/AAAA</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(+) Receita Bruta Total</span> 
                                <span id="report-receita-total" class="font-bold">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Consumo</span>
                                <div>
                                    <span id="report-consumo" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-consumo-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-3 rounded-lg bg-slate-200 text-lg">
                                <strong>(=) Lucro Bruto</strong> 
                                <strong id="report-lucro-bruto" class="font-bold">R$ 0,00</strong>
                            </div>
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Despesas Fixas</span> 
                                <div>
                                    <span id="report-despesas-fixas" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-despesas-fixas-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Mão de Obra</span> 
                                <div>
                                    <span id="report-mao-de-obra" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-mao-de-obra-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                             <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Impostos e Taxas</span> 
                                <div>
                                    <span id="report-impostos-taxas" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-impostos-taxas-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-4 rounded-lg bg-blue-100 text-xl">
                                <strong>(=) Lucro Líquido</strong> 
                                <div>
                                    <strong id="report-lucro-liquido" class="font-bold text-blue-800">R$ 0,00</strong>
                                    <strong id="report-lucro-liquido-perc" class="text-sm text-blue-700 ml-2">(0.00%)</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="export-pdf-btn" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Exportar Relatório Detalhado (PDF)</button>
                </div>
            </div>
            <div id="tab-perfil" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Meu Cadastro</h2>
                    <form id="perfil-form" class="space-y-3">
                        <input type="text" id="perfil-nome" class="w-full p-2 border rounded" placeholder="Nome">
                        <input type="tel" id="perfil-telefone" class="w-full p-2 border rounded" placeholder="Telefone">
                        <input type="email" id="perfil-email" class="w-full p-2 border rounded bg-slate-100" disabled>
                        <input type="text" id="perfil-cnpj" class="w-full p-2 border rounded bg-slate-100" disabled>
                        <input type="text" id="perfil-razao" class="w-full p-2 border rounded bg-slate-100" disabled>
                        <input type="text" id="perfil-plano" class="w-full p-2 border rounded bg-slate-100" disabled>
                        <input type="text" id="perfil-status" class="w-full p-2 border rounded bg-slate-100" disabled>
                        <input type="text" id="perfil-data" class="w-full p-2 border rounded bg-slate-100" disabled>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded">Salvar</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Container oculto para gerar o conteúdo detalhado do PDF -->
    <div id="pdf-detailed-content" class="hidden" style="position: absolute; left: -9999px; width: 800px; background: white; padding: 20px;">
        <div class="pdf-header">
            <img src="https://i.imgur.com/5faoeha.jpeg" alt="Logo" style="max-width:120px;margin:0 auto;display:block;">
        </div>
    </div>


    <!-- Modal de confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="modal-text" class="mb-4">Tem certeza que deseja excluir este item?</p>
            <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg mr-2">Confirmar</button>
            <button id="cancel-delete-btn" class="bg-slate-300 text-slate-800 px-4 py-2 rounded-lg">Cancelar</button>
        </div>
    </div>

    <!-- ADMIN -->
    <div id="admin-screen" class="hidden min-h-screen flex items-center justify-center p-4 app-bg">
        <div class="w-full max-w-xl bg-white p-6 rounded-xl shadow">
            <h2 class="text-xl font-bold mb-4">Painel Administrativo</h2>
            <div class="flex mb-4 border-b">
                <button id="admin-tab-cadastro-btn" class="px-3 py-2 border-b-2 tab-active">Cadastro</button>
                <button id="admin-tab-usuarios-btn" class="px-3 py-2 border-b-2">Usuários</button>
            </div>
            <div id="admin-tab-cadastro" class="admin-tab-content admin-tab-content-active">
                <form id="client-form" class="space-y-3">
                    <input type="text" id="client-nome" placeholder="Nome" class="w-full p-2 border rounded" required>
                    <input type="email" id="client-email" placeholder="Email" class="w-full p-2 border rounded" required>
                    <input type="text" id="client-cnpj" placeholder="CNPJ" class="w-full p-2 border rounded" required>
                    <input type="text" id="client-razao" placeholder="Razão Social" class="w-full p-2 border rounded" required>
                    <input type="text" id="client-fantasia" placeholder="Nome Fantasia" class="w-full p-2 border rounded" required>
                    <input type="tel" id="client-telefone" placeholder="Telefone" class="w-full p-2 border rounded">
                    <select id="client-plano" class="w-full p-2 border rounded" required>
                        <option value="basico">Básico</option>
                        <option value="premium">Premium</option>
                    </select>
                    <select id="client-tempo" class="w-full p-2 border rounded" required>
                        <option value="6">6 meses</option>
                        <option value="12">12 meses</option>
                        <option value="24">24 meses</option>
                    </select>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded">Cadastrar Usuário</button>
                </form>
            </div>
            <div id="admin-tab-usuarios" class="admin-tab-content">
                <div class="mt-6">
                    <div id="clients-list" class="text-xs"></div>
                </div>
            </div>

            <button id="admin-logout" class="mt-6 w-full bg-red-600 text-white py-2 rounded">Sair</button>
        </div>

    </div>
    <!-- jsPDF and html2canvas for PDF Export -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const adminEmail = 'admin@gestao.com';
        const adminPassword = 'admin123';

        const authScreen = document.getElementById('auth-screen');
        const adminScreen = document.getElementById('admin-screen');
        const firstAccessScreen = document.getElementById('first-access-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginFormDiv = document.getElementById('login-form-div');
        const clientForm = document.getElementById('client-form');
        const clientsList = document.getElementById('clients-list');
        const adminTabCadastroBtn = document.getElementById('admin-tab-cadastro-btn');
        const adminTabUsuariosBtn = document.getElementById('admin-tab-usuarios-btn');
        const adminTabCadastro = document.getElementById('admin-tab-cadastro');
        const adminTabUsuarios = document.getElementById('admin-tab-usuarios');
        const adminLogout = document.getElementById('admin-logout');
        const firstAccessForm = document.getElementById('first-access-form');
        const logoutButton = document.getElementById('logout-button');
        const perfilForm = document.getElementById('perfil-form');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.classList.remove('tab-active'));
                tabContents.forEach(c => c.classList.remove('tab-content-active'));
                btn.classList.add('tab-active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('tab-content-active');
            });
        });

        function show(el) {
            authScreen.classList.add('hidden');
            adminScreen.classList.add('hidden');
            firstAccessScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
            el.classList.remove('hidden');
        }


        function switchAdminTab(tab) {
            adminTabCadastro.classList.remove('admin-tab-content-active');
            adminTabUsuarios.classList.remove('admin-tab-content-active');
            adminTabCadastroBtn.classList.remove('tab-active');
            adminTabUsuariosBtn.classList.remove('tab-active');
            if (tab === 'cadastro') {
                adminTabCadastro.classList.add('admin-tab-content-active');
                adminTabCadastroBtn.classList.add('tab-active');
            } else {
                adminTabUsuarios.classList.add('admin-tab-content-active');
                adminTabUsuariosBtn.classList.add('tab-active');
            }
        }

        adminTabCadastroBtn.addEventListener('click', function() {
            switchAdminTab('cadastro');
        });
        adminTabUsuariosBtn.addEventListener('click', function() {
            switchAdminTab('usuarios');
            loadUsers();
        });

        // Auto cadastro desabilitado. Apenas administradores podem criar usuários.

        async function ensureAdmin() {
            try {
                await auth.signInWithEmailAndPassword(adminEmail, adminPassword);
            } catch (e) {
                if (e.code === 'auth/user-not-found') {
                    await auth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                }
            } finally {
                await auth.signOut();
            }
        }

        async function loadUsers() {
            const snap = await db.collection('usuarios').orderBy('dataCadastro', 'desc').get();
            const users = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(u => u.email !== adminEmail);

            clientsList.innerHTML = users.map(u => {
                const label = !u.aprovado ? 'Autorizar' : (u.status === 'ativo' ? 'Cancelar' : 'Ativar');
                const nextStatus = !u.aprovado ? 'ativo' : (u.status === 'ativo' ? 'inativo' : 'ativo');
                const approve = !u.aprovado;
                const color = label === 'Cancelar' ? 'bg-red-600' : 'bg-green-600';
                const meses = u.tempoContrato || u.tempoLiberacao || '';
                return `
                    <div class="bg-white p-4 shadow rounded mb-4 mx-auto max-w-[350px] text-center">
                        <p class="text-lg font-bold">${u.razaoSocial || ''}</p>
                        <p class="text-sm text-slate-500 mb-4">${meses ? meses + ' meses' : ''}</p>
                        <button onclick="toggleStatus('${u.id}', '${nextStatus}', ${approve})" class="w-full ${color} text-white py-2 rounded">${label}</button>
                    </div>
                `;
            }).join('');
        }

        function fillProfile(data) {
            document.getElementById('perfil-nome').value = data.nome || '';
            document.getElementById('perfil-telefone').value = data.telefone || '';
            document.getElementById('perfil-email').value = data.email || '';
            document.getElementById('perfil-cnpj').value = data.cnpj || '';
            document.getElementById('perfil-razao').value = data.razaoSocial || '';
            document.getElementById('perfil-plano').value = data.plano || '';
            document.getElementById('perfil-status').value = data.status || '';
            if (data.dataCadastro && data.dataCadastro.toDate) {
                document.getElementById('perfil-data').value = data.dataCadastro.toDate().toLocaleDateString();
            }
            document.getElementById('header-company-name').textContent = data.nomeFantasia || data.razaoSocial || '';
            document.getElementById('header-company-cnpj').textContent = data.cnpj || '';
        }


        async function toggleStatus(id, status, approve = false) {
            try {
                const update = { status };
                if (approve) update.aprovado = true;
                await db.collection('usuarios').doc(id).update(update);
                loadUsers();
                alert('Status atualizado');
            } catch (err) {
                alert('Erro ao alterar status: ' + err.message);
            }
        }

        async function editarTempo(id, atual) {
            const novo = prompt('Novo tempo de contrato (6, 12 ou 24 meses)', atual);
            if (!novo) return;
            const valor = parseInt(novo);
            if (![6, 12, 24].includes(valor)) {
                alert('Tempo inválido');
                return;
            }
            try {
                await db.collection('usuarios').doc(id).update({ tempoLiberacao: valor, tempoContrato: valor });
                loadUsers();
                alert('Tempo atualizado');
            } catch (err) {
                alert('Erro ao alterar tempo: ' + err.message);
            }
        }

        window.toggleStatus = toggleStatus;
        window.editarTempo = editarTempo;

        perfilForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('perfil-nome').value;
            const telefone = document.getElementById('perfil-telefone').value;
            try {
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ nome, telefone });
                const doc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
                const data = doc.data();
                localStorage.setItem('usuario', JSON.stringify(data));
                fillProfile(data);
                alert('Dados atualizados');
            } catch (err) {
                alert('Erro ao atualizar: ' + err.message);
            }
        });

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const cred = await auth.signInWithEmailAndPassword(email, password);
                const user = cred.user;
                if (user.email === adminEmail) {
                    show(adminScreen);
                    loadUsers();
                } else {
                    const ref = db.collection('usuarios').doc(user.uid);
                    const doc = await ref.get();
                    if (!doc.exists) {
                        alert('Usuário não cadastrado. Solicite acesso ao administrador.');
                        await auth.signOut();
                        return;
                    }
                    const data = doc.data();
                    if (!data.aprovado) {
                        alert('Aguardando aprovação do administrador');
                        await auth.signOut();
                        return;
                    }
                    if (data.status === 'desativado' || data.status === 'inativo') {
                        alert('Usuário desativado');
                        await auth.signOut();
                        return;
                    }
                    if (data.primeiroAcesso !== false) {
                        show(firstAccessScreen);
                        return;
                    }
                    localStorage.setItem('usuario', JSON.stringify(data));
                    fillProfile(data);
                    show(mainApp);
                }
            } catch (err) {
                switch (err.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        loginError.textContent = 'Email ou senha inválidos';
                        break;
                    default:
                        loginError.textContent = err.message;
                }
                alert('Falha no login: ' + (err.message || err));
            }
        });

        firstAccessForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPass = document.getElementById('first-password').value;
            const confirmPass = document.getElementById('first-confirm').value;
            if (newPass !== confirmPass) {
                alert('As senhas não conferem');
                return;
            }
            if (newPass.length < 6 || newPass === 'gestao123') {
                alert('Escolha uma senha mais forte');
                return;
            }
            try {
                await auth.currentUser.updatePassword(newPass);
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ primeiroAcesso: false });
                const doc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
                const data = doc.data();
                localStorage.setItem('usuario', JSON.stringify(data));
                fillProfile(data);
                show(mainApp);
            } catch (err) {
                alert(err.message);
            }
        });

        clientForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('client-nome').value;
            const email = document.getElementById('client-email').value;
            const cnpj = document.getElementById('client-cnpj').value;
            const razao = document.getElementById('client-razao').value;
            const fantasia = document.getElementById('client-fantasia').value;
            const telefone = document.getElementById('client-telefone').value;
            const plano = document.getElementById('client-plano').value;
            const tempo = document.getElementById('client-tempo').value;
            try {
            const secApp = firebase.initializeApp(firebase.app().options, 'sec');
            const tempPass = 'gestao123';
                const dup = await db.collection('usuarios').where('cnpj', '==', cnpj).limit(1).get();
                if (!dup.empty) {
                    alert('CNPJ já cadastrado');
                    return;
                }
            const cred = await secApp.auth().createUserWithEmailAndPassword(email, tempPass);
                await db.collection('usuarios').doc(cred.user.uid).set({
                    uid: cred.user.uid,
                    nome,
                    email,
                    cnpj,
                    razaoSocial: razao,
                    nomeFantasia: fantasia,
                    telefone,
                    plano,
                    tempoLiberacao: parseInt(tempo),
                    tempoContrato: parseInt(tempo),
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'ativo',
                    aprovado: true,
                    primeiroAcesso: true
                });
                await secApp.auth().signOut();
                secApp.delete();
                e.target.reset();
                loadUsers();
                alert('Usuário cadastrado com sucesso!');
            } catch (err) {
                if (err.code === 'auth/email-already-in-use') {
                    alert('Email já cadastrado');
                } else {
                    alert(err.message);
                }
            }
        });

        adminLogout.addEventListener('click', function() {
            auth.signOut();
            show(authScreen);
            loginError.textContent = '';
        });

        logoutButton.addEventListener('click', function() {
            auth.signOut();
            show(authScreen);
            loginError.textContent = '';
        });

        ensureAdmin();
        show(authScreen);
    });
    </script>


</body>
</html>

