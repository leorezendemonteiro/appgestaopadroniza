<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão DRE - CORRETAGESTAO02</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-button { padding: 8px 16px; margin-right: 4px; background: #ccc; border: none; cursor: pointer; }
    .tab-button.active { background: #666; color: #fff; }
  </style>
</head>
<body>
  <h1>Relatório DRE com Gráficos e PDFs</h1>

  <div>
    <label for="tipoRelatorio">Tipo de Relatório:</label>
    <select id="tipoRelatorio">
      <option value="mensal">Mensal</option>
      <option value="anual">Anual</option>
    </select>
    <input id="periodoRelatorio" type="month">
    <button onclick="gerarRelatorioPDF()">Gerar PDF Completo</button>
    <button onclick="gerarResumoDRE()">Gerar PDF Resumido</button>
  </div>

  <canvas id="graficoDRE" width="600" height="300"></canvas>
  <div id="resumoValores"></div>
  <div id="detalhamentoLancamentos"></div>

<script>
function formatarReal(valor) {
  return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function calcularTotais() {
  const settings = JSON.parse(localStorage.getItem('settings')) || {};
  const tipo = document.getElementById('tipoRelatorio').value;
  const periodo = document.getElementById('periodoRelatorio').value;
  const ano = periodo.split('-')[0];
  const mes = periodo.split('-')[1];

  function filtrar(lista) {
    return lista.filter(item => {
      const d = new Date(item.data);
      return tipo === 'anual' ? d.getFullYear() === +ano : (d.getMonth() + 1 === +mes && d.getFullYear() === +ano);
    });
  }

  const receitas = filtrar(JSON.parse(localStorage.getItem('receitas') || '[]'));
  const cmv = filtrar(JSON.parse(localStorage.getItem('cmv') || '[]'));
  const fixos = filtrar(JSON.parse(localStorage.getItem('fixos') || '[]'));
  const mo = filtrar(JSON.parse(localStorage.getItem('mo') || '[]'));

  const totalReceitas = receitas.reduce((acc, r) => acc + r.valor, 0);
  const totalCMV = cmv.reduce((acc, r) => acc + r.valor, 0);
  const totalFixos = fixos.reduce((acc, r) => acc + r.valor, 0);
  const totalMO = mo.reduce((acc, r) => acc + r.valor, 0);
  const impostos = (settings.taxRate || 0) / 100 * totalReceitas;
  const lucroBruto = totalReceitas - totalCMV;
  const lucroLiquido = lucroBruto - totalFixos - totalMO - impostos;

  return { totalReceitas, totalCMV, totalFixos, totalMO, impostos, lucroLiquido, receitas, cmv, fixos, mo };
}

function atualizarGrafico() {
  const ctx = document.getElementById('graficoDRE').getContext('2d');
  const { totalReceitas, totalCMV, totalFixos, totalMO, impostos, lucroLiquido } = calcularTotais();

  const chartData = {
    labels: ['CMV', 'Fixos', 'Mão de Obra', 'Impostos/Taxas', 'Lucro Líquido'],
    datasets: [{
      data: [
        (totalCMV / totalReceitas * 100),
        (totalFixos / totalReceitas * 100),
        (totalMO / totalReceitas * 100),
        (impostos / totalReceitas * 100),
        (lucroLiquido / totalReceitas * 100)
      ],
      backgroundColor: ['#f87171', '#facc15', '#60a5fa', '#34d399', '#a78bfa'],
    }]
  };

  if (window.chartInstance) window.chartInstance.destroy();
  window.chartInstance = new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: {
      plugins: {
        tooltip: { callbacks: { label: ctx => ctx.raw.toFixed(2) + '%' } },
        legend: { display: false }
      },
      scales: { y: { title: { display: true, text: '% sobre Receita' }, beginAtZero: true, max: 100 } }
    }
  });
}

function gerarRelatorioPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const dados = calcularTotais();

  doc.text('Relatório Completo DRE', 14, 20);
  doc.setFontSize(10);
  let y = 30;

  for (const tipo of ['receitas', 'cmv', 'fixos', 'mo']) {
    doc.text(tipo.toUpperCase(), 14, y); y += 6;
    dados[tipo].forEach(item => {
      doc.text(`• ${item.tipo} - ${item.descricao || '-'} - ${item.fornecedor || '-'} - ${item.data} - ${formatarReal(item.valor)}`, 14, y);
      y += 6;
      if (y > 280) { doc.addPage(); y = 20; }
    });
    y += 4;
  }

  doc.save('relatorio-completo.pdf');
}

function gerarResumoDRE() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { totalReceitas, totalCMV, totalFixos, totalMO, impostos, lucroLiquido } = calcularTotais();

  doc.setFontSize(14);
  doc.text('DRE Resumido', 14, 20);
  doc.setFontSize(12);
  doc.text(`Receita Bruta: ${formatarReal(totalReceitas)}`, 14, 30);
  doc.text(`CMV: ${formatarReal(totalCMV)} (${(totalCMV / totalReceitas * 100).toFixed(2)}%)`, 14, 40);
  doc.text(`Despesas Fixas: ${formatarReal(totalFixos)} (${(totalFixos / totalReceitas * 100).toFixed(2)}%)`, 14, 50);
  doc.text(`Mão de Obra: ${formatarReal(totalMO)} (${(totalMO / totalReceitas * 100).toFixed(2)}%)`, 14, 60);
  doc.text(`Impostos: ${formatarReal(impostos)} (${(impostos / totalReceitas * 100).toFixed(2)}%)`, 14, 70);
  doc.text(`Lucro Líquido: ${formatarReal(lucroLiquido)} (${(lucroLiquido / totalReceitas * 100).toFixed(2)}%)`, 14, 80);

  doc.save('dre-resumido.pdf');
}

// Gatilhos
['tipoRelatorio', 'periodoRelatorio'].forEach(id => document.getElementById(id).addEventListener('change', atualizarGrafico));
</script>

</body>
</html>
