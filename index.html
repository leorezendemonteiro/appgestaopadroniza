<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORRETAGESTAO02 - DRE Simplificado</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCqYsuVE3oju_BT_nMDNyws-8QiglgZN-8",
        authDomain: "appgestao-trakto.firebaseapp.com",
        projectId: "appgestao-trakto",
        storageBucket: "appgestao-trakto.firebasestorage.app",
        messagingSenderId: "967772034888",
        appId: "1:967772034888:web:37ac2d26c3092c8413857d"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();
    </script>
    <style>
        /* Estilo para a aba ativa */
        .tab-active {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: #ffffff;
        }
        /* Esconde as abas inativas */
        .tab-content {
            display: none;
        }
        /* Mostra a aba ativa */
        .tab-content-active {
            display: block;
        }
        /* Estilos para a área de impressão do PDF */
        #pdf-detailed-content {
            font-family: Arial, sans-serif;
            color: #333;
        }
        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #ccc;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 9pt;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        .pdf-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .pdf-summary-table {
            width: 100%;
            margin-top: 1rem;
            font-size: 10pt;
        }
         .pdf-summary-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">

    <!-- =========== AUTENTICAÇÃO =========== -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg text-center">
            <img src="https://placehold.co/250x80/e2e8f0/475569?text=Logo+Padroniza" alt="Logo Padroniza" class="mx-auto mb-4">
            <div id="login-form-div" class="space-y-4">
                <h2 class="text-xl font-bold mb-4">Acessar Conta</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Entrar</button>
                </form>
                <p class="text-sm">Não possui cadastro? <a href="#" id="show-register" class="text-indigo-600">Criar conta</a></p>
            </div>
            <div id="register-form-div" class="space-y-4 hidden">
                <h2 class="text-xl font-bold mb-4">Cadastro</h2>
                <form id="register-form" class="space-y-3">
                    <input type="text" id="reg-razao" placeholder="Razão Social" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="text" id="reg-fantasia" placeholder="Nome Fantasia" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="text" id="reg-cnpj" placeholder="CNPJ" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="text" id="reg-endereco" placeholder="Endereço" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="email" id="reg-email" placeholder="Email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <input type="password" id="reg-senha" placeholder="Senha" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Cadastrar</button>
                </form>
                <p class="text-sm"><a href="#" id="show-login" class="text-indigo-600">Já tenho conta</a></p>
            </div>
        </div>
    </div>

    <!-- =========== TELA DE BOAS-VINDAS =========== -->
    <div id="welcome-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg text-center">
            <img src="https://placehold.co/250x80/e2e8f0/475569?text=Logo+Padroniza" alt="Logo Padroniza" class="mx-auto mb-8">
            <h1 class="text-2xl font-bold mb-6 text-slate-700">Bem-vindo ao DRE Simplificado</h1>
            <form id="company-form" class="space-y-4">
                <input type="text" id="company-name" name="name" placeholder="Nome da sua empresa" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <input type="text" id="company-cnpj" name="cnpj" placeholder="CNPJ" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300">
                    Iniciar DRE
                </button>
            </form>
        </div>
    </div>

    <!-- =========== INTERFACE PRINCIPAL DO APP =========== -->
    <div id="main-app" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
             <div class="flex items-center space-x-3">
                <img src="https://placehold.co/150x50/e2e8f0/475569?text=Logo+Padroniza" alt="Logo Padroniza" id="header-logo">
                <div>
                    <h1 id="header-company-name" class="text-lg font-bold text-slate-800">Nome da Empresa</h1>
                    <p id="header-company-cnpj" class="text-sm text-slate-500">CNPJ</p>
                </div>
            </div>
            <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">Sair</button>
        </header>

        <!-- Navegação das Abas -->
        <nav class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-1 sm:space-x-2 overflow-x-auto -mb-px">
                    <button data-tab="calibracao" class="tab-button tab-active whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Calibração</button>
                    <button data-tab="receitas" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Receitas</button>
                    <button data-tab="despesas-variaveis" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Consumo</button>
                    <button data-tab="despesas-fixas" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Desp. Fixas</button>
                    <button data-tab="mao-de-obra" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Mão de Obra</button>
                    <button data-tab="relatorio" class="tab-button whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-medium text-sm">Relatório</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Conteúdo da Aba Calibração -->
            <div id="tab-calibracao" class="tab-content tab-content-active">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Calibração de Taxas e Impostos</h2>
                    <form id="calibration-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label for="imposto-faturamento" class="text-sm font-medium">Imposto Faturamento (%)</label>
                            <input type="number" id="imposto-faturamento" name="imposto_faturamento" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 4.5">
                        </div>
                        <div class="space-y-1">
                            <label for="taxa-debito" class="text-sm font-medium">Taxa de Débito (%)</label>
                            <input type="number" id="taxa-debito" name="taxa_debito" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 1.99">
                        </div>
                        <div class="space-y-1">
                            <label for="taxa-credito" class="text-sm font-medium">Taxa de Crédito (%)</label>
                            <input type="number" id="taxa-credito" name="taxa_credito" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 3.49">
                        </div>
                        <div class="space-y-1">
                            <label for="comissao-ifood" class="text-sm font-medium">Comissão iFood (%)</label>
                            <input type="number" id="comissao-ifood" name="comissao_ifood" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 12">
                        </div>
                        <div class="space-y-1">
                            <label for="comissao-99" class="text-sm font-medium">Comissão 99 (%)</label>
                            <input type="number" id="comissao-99" name="comissao_99" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 10">
                        </div>
                         <div class="space-y-1">
                            <label for="encargos-diversos" class="text-sm font-medium">Encargos Diversos (%)</label>
                            <input type="number" id="encargos-diversos" name="encargos_diversos" class="w-full p-2 border rounded-lg" step="0.01" placeholder="Ex: 1.5">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Salvar Calibração</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Conteúdo da Aba Receitas -->
            <div id="tab-receitas" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Nova Receita</h2>
                    <form id="receitas-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                             <label for="receita-descricao" class="text-sm font-medium">Descrição</label>
                             <input type="text" id="receita-descricao" name="descricao" placeholder="Ex: Vendas do dia" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                             <label for="receita-tipo" class="text-sm font-medium">Tipo de Pagamento</label>
                             <select id="receita-tipo" name="tipo" class="w-full p-2 border rounded-lg bg-white" required>
                                <option value="Crédito">Crédito</option>
                                <option value="Débito">Débito</option>
                                <option value="Pix">Pix</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="iFood">iFood</option>
                                <option value="99">99</option>
                             </select>
                        </div>
                        <div>
                            <label for="receita-valor" class="text-sm font-medium">Valor (R$)</label>
                            <input type="number" id="receita-valor" name="valor" placeholder="150.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div class="md:col-span-2">
                             <label for="receita-data" class="text-sm font-medium">Data</label>
                             <input type="date" id="receita-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="md:col-span-2">
                             <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Receita</button>
                        </div>
                    </form>
                </div>
                <div id="receitas-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Receitas Salvas</h3>
                    <div class="overflow-x-auto">
                        <!-- Lista de receitas será inserida aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo da Aba Consumo (Despesas Variáveis) -->
            <div id="tab-despesas-variaveis" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Lançamento de Consumo</h2>
                    <form id="despesas-variaveis-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="dv-categoria" class="text-sm font-medium">Categoria</label>
                            <select id="dv-categoria" name="categoria" class="w-full p-2 border rounded-lg bg-white" required>
                                <option>Alimentar</option>
                                <option>Produtos de limpeza e higiene</option>
                                <option>Embalagens e descartáveis</option>
                                <option>Gás</option>
                                <option>Bebidas e similares</option>
                                <option>Outros</option>
                            </select>
                        </div>
                        <div>
                            <label for="dv-descricao" class="text-sm font-medium">Descrição</label>
                            <input type="text" id="dv-descricao" name="descricao" placeholder="Ex: Compra de carnes" class="w-full p-2 border rounded-lg">
                        </div>
                         <div>
                            <label for="dv-valor" class="text-sm font-medium">Valor (R$)</label>
                            <input type="number" id="dv-valor" name="valor" placeholder="350.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div>
                            <label for="dv-data" class="text-sm font-medium">Data</label>
                            <input type="date" id="dv-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="dv-fornecedor" class="text-sm font-medium">Fornecedor</label>
                            <input type="text" id="dv-fornecedor" name="fornecedor" placeholder="Ex: Casa de Carnes ABC" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Lançamento</button>
                        </div>
                    </form>
                </div>
                <div id="despesas-variaveis-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Lançamentos de Consumo Salvos</h3>
                     <div class="overflow-x-auto">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Despesas Fixas -->
            <div id="tab-despesas-fixas" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Despesa Fixa</h2>
                    <form id="despesas-fixas-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="df-categoria" class="text-sm font-medium">Categoria</label>
                            <select id="df-categoria" name="categoria" class="w-full p-2 border rounded-lg bg-white" required>
                                <option>Aluguel</option>
                                <option>IPTU</option>
                                <option>Água</option>
                                <option>Energia elétrica</option>
                                <option>Internet/telefone</option>
                                <option>Mensalidade de software</option>
                                <option>Contabilidade</option>
                                <option>Marketing</option>
                                <option>Parcela de financiamento</option>
                                <option>Prólabore</option>
                            </select>
                        </div>
                        <div>
                            <label for="df-valor" class="text-sm font-medium">Valor (R$)</label>
                            <input type="number" id="df-valor" name="valor" placeholder="1500.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div>
                            <label for="df-data" class="text-sm font-medium">Data</label>
                            <input type="date" id="df-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="df-fornecedor" class="text-sm font-medium">Fornecedor</label>
                            <input type="text" id="df-fornecedor" name="fornecedor" placeholder="Ex: Imobiliária Central" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Despesa Fixa</button>
                        </div>
                    </form>
                </div>
                <div id="despesas-fixas-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Despesas Fixas Salvas</h3>
                     <div class="overflow-x-auto">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Mão de Obra -->
            <div id="tab-mao-de-obra" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Adicionar Custo de Mão de Obra</h2>
                    <form id="mao-de-obra-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="mo-categoria" class="text-sm font-medium">Categoria</label>
                            <select id="mo-categoria" name="categoria" class="w-full p-2 border rounded-lg bg-white" required>
                                <option>Salários</option>
                                <option>Férias</option>
                                <option>Verbas rescisórias</option>
                                <option>INSS</option>
                                <option>FGTS</option>
                                <option>Vale transporte</option>
                                <option>Vale alimentação</option>
                                <option>Exames periódicos</option>
                                <option>Uniformes</option>
                            </select>
                        </div>
                        <div>
                             <label for="mo-valor" class="text-sm font-medium">Valor (R$)</label>
                             <input type="number" id="mo-valor" name="valor" placeholder="2500.00" class="w-full p-2 border rounded-lg" step="0.01" required>
                        </div>
                        <div>
                             <label for="mo-data" class="text-sm font-medium">Data</label>
                             <input type="date" id="mo-data" name="data" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="mo-fornecedor" class="text-sm font-medium">Fornecedor / Funcionário</label>
                            <input type="text" id="mo-fornecedor" name="fornecedor" placeholder="Ex: Nome do Funcionário" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full mt-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Salvar Mão de Obra</button>
                        </div>
                    </form>
                </div>
                <div id="mao-de-obra-list" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Custos de Mão de Obra Salvos</h3>
                     <div class="overflow-x-auto">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Relatório -->
            <div id="tab-relatorio" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Gerar Relatório DRE</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="report-type" class="text-sm font-medium">Tipo</label>
                            <select id="report-type" class="w-full p-2 border rounded-lg bg-white">
                                <option value="monthly">Mensal</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                        <div id="month-selector-div">
                            <label for="report-month" class="text-sm font-medium">Mês</label>
                            <input type="month" id="report-month" class="w-full p-2 border rounded-lg">
                        </div>
                        <div id="year-selector-div" class="hidden">
                             <label for="report-year" class="text-sm font-medium">Ano</label>
                             <input type="number" id="report-year" placeholder="2024" class="w-full p-2 border rounded-lg">
                        </div>
                         <div>
                             <button id="generate-report-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Gerar Relatório</button>
                         </div>
                    </div>
                </div>

                <!-- Container para o relatório visível na tela -->
                <div id="report-output" class="mt-6 bg-white p-6 rounded-xl shadow-lg hidden">
                    <!-- Este será o resumo visível na tela -->
                    <div id="report-summary-view">
                        <div class="flex justify-between items-start mb-6 border-b pb-4">
                            <div>
                                <h3 id="report-company-name-view" class="text-2xl font-bold">Nome da Empresa</h3>
                                <p id="report-company-cnpj-view" class="text-slate-600">CNPJ</p>
                            </div>
                            <div class="text-right">
                                <h4 class="font-bold">Relatório DRE</h4>
                                <p id="report-period-view" class="text-slate-600">Período</p>
                                <p id="report-date-view" class="text-sm text-slate-500">Gerado em: DD/MM/AAAA</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(+) Receita Bruta Total</span> 
                                <span id="report-receita-total" class="font-bold">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Consumo</span>
                                <div>
                                    <span id="report-consumo" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-consumo-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-3 rounded-lg bg-slate-200 text-lg">
                                <strong>(=) Lucro Bruto</strong> 
                                <strong id="report-lucro-bruto" class="font-bold">R$ 0,00</strong>
                            </div>
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Despesas Fixas</span> 
                                <div>
                                    <span id="report-despesas-fixas" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-despesas-fixas-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Mão de Obra</span> 
                                <div>
                                    <span id="report-mao-de-obra" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-mao-de-obra-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                             <div class="flex justify-between p-2 rounded-lg bg-slate-50">
                                <span>(-) Impostos e Taxas</span> 
                                <div>
                                    <span id="report-impostos-taxas" class="font-bold text-red-600">R$ 0,00</span>
                                    <span id="report-impostos-taxas-perc" class="text-sm text-slate-500 ml-2">(0.00%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-4 rounded-lg bg-blue-100 text-xl">
                                <strong>(=) Lucro Líquido</strong> 
                                <div>
                                    <strong id="report-lucro-liquido" class="font-bold text-blue-800">R$ 0,00</strong>
                                    <strong id="report-lucro-liquido-perc" class="text-sm text-blue-700 ml-2">(0.00%)</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="export-pdf-btn" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Exportar Relatório Detalhado (PDF)</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Container oculto para gerar o conteúdo detalhado do PDF -->
    <div id="pdf-detailed-content" class="hidden" style="position: absolute; left: -9999px; width: 800px; background: white; padding: 20px;"></div>


    <!-- Modal de confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="modal-text" class="mb-4">Tem certeza que deseja excluir este item?</p>
            <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg mr-2">Confirmar</button>
            <button id="cancel-delete-btn" class="bg-slate-300 text-slate-800 px-4 py-2 rounded-lg">Cancelar</button>
        </div>
    </div>

    <!-- ADMIN -->
    <div id="admin-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white p-6 rounded-xl shadow">
            <h2 class="text-xl font-bold mb-4">Acesso Admin</h2>
            <form id="admin-login-form" class="space-y-4">
                <input type="email" id="admin-email" placeholder="Email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                <input type="password" id="admin-password" placeholder="Senha" class="w-full p-3 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Entrar</button>
            </form>
            <div id="admin-panel" class="hidden mt-6">
                <h3 class="font-bold mb-2">Empresas</h3>
                <div id="admin-empresas" class="text-sm"></div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===================================================================
        // 1. VARIÁVEIS GLOBAIS E CONSTANTES
        // ===================================================================
        const appState = {
            companyInfo: null,
            calibration: {},
            receitas: [],
            despesasVariaveis: [],
            despesasFixas: [],
            maoDeObra: [],
        };

        const MASTER_EMAIL = 'master@example.com';
        const MASTER_PASSWORD = 'master123';

        const STORAGE_KEYS = {
            COMPANY: 'corretagestao02_empresa',
            CALIBRATION: 'corretagestao02_calibracao',
            RECEITAS: 'corretagestao02_receitas',
            DV: 'corretagestao02_despesasVariaveis',
            DF: 'corretagestao02_despesasFixas',
            MO: 'corretagestao02_maoDeObra',
        };

        // Elementos da DOM
        const authScreen = document.getElementById('auth-screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainApp = document.getElementById('main-app');
        const companyForm = document.getElementById('company-form');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const loginFormDiv = document.getElementById('login-form-div');
        const registerFormDiv = document.getElementById('register-form-div');
        const adminScreen = document.getElementById('admin-screen');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminPanel = document.getElementById('admin-panel');
        const adminEmpresas = document.getElementById('admin-empresas');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const logoutButton = document.getElementById('logout-button');

        // ===================================================================
        // 2. FUNÇÕES DE INICIALIZAÇÃO E ESTADO
        // ===================================================================
        function loadState() {
            appState.companyInfo = JSON.parse(localStorage.getItem(STORAGE_KEYS.COMPANY));
            appState.calibration = JSON.parse(localStorage.getItem(STORAGE_KEYS.CALIBRATION)) || {};
            appState.receitas = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECEITAS)) || [];
            appState.despesasVariaveis = JSON.parse(localStorage.getItem(STORAGE_KEYS.DV)) || [];
            appState.despesasFixas = JSON.parse(localStorage.getItem(STORAGE_KEYS.DF)) || [];
            appState.maoDeObra = JSON.parse(localStorage.getItem(STORAGE_KEYS.MO)) || [];
        }
        
        function saveState(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        function init() {
            loadState();
            if (window.location.pathname.includes('admin')) {
                showAdminScreen();
                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (document.getElementById('admin-email').value === MASTER_EMAIL && document.getElementById('admin-password').value === MASTER_PASSWORD) {
                        adminLoginForm.classList.add('hidden');
                        adminPanel.classList.remove('hidden');
                        const snapshot = await db.collection('empresas').get();
                        adminEmpresas.innerHTML = snapshot.docs.map(d => `<div class='border-b py-1'>${d.data().razao_social} - <button data-id='${d.id}' class='liberar text-indigo-600'>Liberar</button></div>`).join('');
                        adminEmpresas.addEventListener('click', async (ev) => {
                            if (ev.target.classList.contains('liberar')) {
                                const id = ev.target.dataset.id;
                                await db.collection('empresas').doc(id).update({ status: 'ativo', validade: '12m' });
                                ev.target.textContent = 'Liberado';
                            }
                        });
                    } else {
                        alert('Credenciais inválidas');
                    }
                });
                return;
            }
            auth.onAuthStateChanged(async user => {
                if (user) {
                    const userSnap = await db.collection('usuarios').doc(user.uid).get();
                    if (!userSnap.exists) { showAuthScreen(); return; }
                    const uData = userSnap.data();
                    if (uData.status !== 'ativo') {
                        alert('Cadastro aguardando liberação ou bloqueado.');
                        auth.signOut();
                        return;
                    }
                    const empSnap = await db.collection('empresas').doc(uData.empresaId).get();
                    if (empSnap.exists) {
                        const d = empSnap.data();
                        appState.companyInfo = { id: empSnap.id, name: d.razao_social, cnpj: d.cnpj };
                        saveState(STORAGE_KEYS.COMPANY, appState.companyInfo);
                        document.getElementById('company-name').value = appState.companyInfo.name || '';
                        document.getElementById('company-cnpj').value = appState.companyInfo.cnpj || '';
                    }
                    showWelcomeScreen();
                } else {
                    showAuthScreen();
                }
            });
            renderAllLists();
            populateCalibrationForm();
            setupReportSelectors();
            addEventListeners();
        }

        // ===================================================================
        // 3. FUNÇÕES DE RENDERIZAÇÃO E UI
        // ===================================================================
        function showAuthScreen() {
            authScreen.style.display = 'flex';
            welcomeScreen.style.display = 'none';
            mainApp.style.display = 'none';
        }

        function showWelcomeScreen() {
            authScreen.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            mainApp.style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('header-company-name').textContent = appState.companyInfo.name;
            document.getElementById('header-company-cnpj').textContent = `CNPJ: ${appState.companyInfo.cnpj}`;
            authScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            adminScreen.style.display = 'none';
            mainApp.style.display = 'block';
        }

        function showAdminScreen() {
            authScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            mainApp.style.display = 'none';
            adminScreen.style.display = 'flex';
        }

        function switchTab(tabName) {
            tabContents.forEach(content => content.classList.remove('tab-content-active'));
            tabButtons.forEach(button => button.classList.remove('tab-active'));
            document.getElementById(`tab-${tabName}`).classList.add('tab-content-active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
        }

        function renderList(containerId, items, columns) {
            const container = document.querySelector(`#${containerId} > div`);
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center py-4">Nenhum item adicionado ainda.</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-slate-200';
            
            const thead = document.createElement('thead');
            thead.className = 'bg-slate-50';
            thead.innerHTML = `
                <tr>
                    ${columns.map(col => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${col.header}</th>`).join('')}
                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-slate-200';
            
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    ${columns.map(col => `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${col.render(item)}</td>`).join('')}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${item.id}" data-type="${containerId.replace('-list', '')}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            container.innerHTML = '';
            container.appendChild(table);
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(parseFloat(value))) {
                return 'R$ 0,00';
            }
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const dateParts = dateString.split('-');
            if(dateParts.length !== 3) return dateString;
            const [year, month, day] = dateParts;
            return `${day}/${month}/${year}`;
        }
        
        function formatPercentage(value) {
            return `(${(value || 0).toFixed(2)}%)`;
        }

        function renderAllLists() {
            renderList('receitas-list', appState.receitas, [
                { header: 'Data', render: item => formatDate(item.data) },
                { header: 'Descrição', render: item => item.descricao || 'N/A' },
                { header: 'Tipo', render: item => item.tipo },
                { header: 'Valor', render: item => formatCurrency(item.valor) },
            ]);
            renderList('despesas-variaveis-list', appState.despesasVariaveis, [
                { header: 'Data', render: item => formatDate(item.data) },
                { header: 'Categoria', render: item => item.categoria },
                { header: 'Descrição', render: item => item.descricao || 'N/A' },
                { header: 'Fornecedor', render: item => item.fornecedor || 'N/A' },
                { header: 'Valor', render: item => formatCurrency(item.valor) },
            ]);
            renderList('despesas-fixas-list', appState.despesasFixas, [
                { header: 'Data', render: item => formatDate(item.data) },
                { header: 'Categoria', render: item => item.categoria },
                { header: 'Fornecedor', render: item => item.fornecedor || 'N/A' },
                { header: 'Valor', render: item => formatCurrency(item.valor) },
            ]);
            renderList('mao-de-obra-list', appState.maoDeObra, [
                { header: 'Data', render: item => formatDate(item.data) },
                { header: 'Categoria', render: item => item.categoria },
                { header: 'Fornecedor/Func.', render: item => item.fornecedor || 'N/A' },
                { header: 'Valor', render: item => formatCurrency(item.valor) },
            ]);
        }
        
        function populateCalibrationForm() {
            const form = document.getElementById('calibration-form');
            for (const key in appState.calibration) {
                if (form.elements[key]) {
                    form.elements[key].value = appState.calibration[key];
                }
            }
        }
        
        function setupReportSelectors() {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            
            document.getElementById('report-month').value = `${year}-${month}`;
            document.getElementById('report-year').value = year;
        }

        // ===================================================================
        // 4. FUNÇÕES DE MANIPULAÇÃO DE DADOS (ADD/DELETE)
        // ===================================================================

        function handleFormSubmit(event, formId, stateKey, stateArray) {
            event.preventDefault();
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            const newItem = { id: Date.now() };

            for (let [key, value] of formData.entries()) {
                 newItem[key] = value;
            }
            
            stateArray.push(newItem);
            saveState(stateKey, stateArray);
            renderAllLists();
            form.reset();
        }

        function showConfirmationModal(text, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-text').textContent = text;
            modal.classList.remove('hidden');

            const confirmBtn = document.getElementById('confirm-delete-btn');
            const cancelBtn = document.getElementById('cancel-delete-btn');

            const confirmHandler = () => { onConfirm(); hideModal(); cleanup(); };
            const cancelHandler = () => { hideModal(); cleanup(); };
            const hideModal = () => modal.classList.add('hidden');
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        }

        function handleDelete(id, type) {
            const onConfirm = () => {
                let stateKey;
                switch (type) {
                    case 'receitas': appState.receitas = appState.receitas.filter(item => item.id !== parseInt(id)); stateKey = STORAGE_KEYS.RECEITAS; break;
                    case 'despesas-variaveis': appState.despesasVariaveis = appState.despesasVariaveis.filter(item => item.id !== parseInt(id)); stateKey = STORAGE_KEYS.DV; break;
                    case 'despesas-fixas': appState.despesasFixas = appState.despesasFixas.filter(item => item.id !== parseInt(id)); stateKey = STORAGE_KEYS.DF; break;
                    case 'mao-de-obra': appState.maoDeObra = appState.maoDeObra.filter(item => item.id !== parseInt(id)); stateKey = STORAGE_KEYS.MO; break;
                    default: console.error('Tipo de exclusão desconhecido:', type); return;
                }
                saveState(stateKey, appState[type.replace(/-/g, '_') === 'despesas_variaveis' ? 'despesasVariaveis' : type.replace(/-/g, '_')]);
                renderAllLists();
            };
            showConfirmationModal('Tem certeza que deseja excluir este item?', onConfirm);
        }

        // ===================================================================
        // 5. LÓGICA DO RELATÓRIO E PDF
        // ===================================================================
        
        function generateReport() {
            const type = document.getElementById('report-type').value;
            let startDate, endDate, periodText;
            
            const toUTCDate = (dateString) => {
                const date = new Date(dateString);
                return new Date(date.valueOf() + date.getTimezoneOffset() * 60 * 1000);
            }

            if (type === 'monthly') {
                const monthValue = document.getElementById('report-month').value;
                if (!monthValue) { alert("Por favor, selecione um mês."); return; }
                const [year, month] = monthValue.split('-');
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0, 23, 59, 59);
                periodText = `${month}/${year}`;
            } else { // yearly
                const year = document.getElementById('report-year').value;
                 if (!year) { alert("Por favor, selecione um ano."); return; }
                startDate = new Date(year, 0, 1);
                endDate = new Date(year, 11, 31, 23, 59, 59);
                periodText = `Anual ${year}`;
            }

            const filterByDate = (item) => {
                const itemDate = toUTCDate(item.data);
                return itemDate >= startDate && itemDate <= endDate;
            };

            const receitasFiltradas = appState.receitas.filter(filterByDate);
            const consumoFiltrado = appState.despesasVariaveis.filter(filterByDate);
            const dfFiltrados = appState.despesasFixas.filter(filterByDate);
            const moFiltrados = appState.maoDeObra.filter(filterByDate);
            
            const totalReceitas = receitasFiltradas.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            const totalConsumo = consumoFiltrado.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            const totalDF = dfFiltrados.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            const totalMO = moFiltrados.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            
            const cal = appState.calibration;
            const receitasPorTipo = receitasFiltradas.reduce((acc, item) => {
                acc[item.tipo] = (acc[item.tipo] || 0) + parseFloat(item.valor || 0); return acc;
            }, {});
            
            const impostoFaturamentoValor = (totalReceitas * (parseFloat(cal.imposto_faturamento) || 0)) / 100;
            const encargosDiversosValor = (totalReceitas * (parseFloat(cal.encargos_diversos) || 0)) / 100;
            const taxaDebitoValor = (receitasPorTipo['Débito'] || 0) * (parseFloat(cal.taxa_debito) || 0) / 100;
            const taxaCreditoValor = (receitasPorTipo['Crédito'] || 0) * (parseFloat(cal.taxa_credito) || 0) / 100;
            const comissaoIfoodValor = (receitasPorTipo['iFood'] || 0) * (parseFloat(cal.comissao_ifood) || 0) / 100;
            const comissao99Valor = (receitasPorTipo['99'] || 0) * (parseFloat(cal.comissao_99) || 0) / 100;

            const totalImpostosTaxas = impostoFaturamentoValor + encargosDiversosValor + taxaDebitoValor + taxaCreditoValor + comissaoIfoodValor + comissao99Valor;
            const taxDetails = { impostoFaturamentoValor, encargosDiversosValor, taxaDebitoValor, taxaCreditoValor, comissaoIfoodValor, comissao99Valor };

            const lucroBruto = totalReceitas - totalConsumo;
            const lucroLiquido = lucroBruto - totalDF - totalMO - totalImpostosTaxas;
            
            const perc = (value) => totalReceitas > 0 ? (value / totalReceitas) * 100 : 0;
            const consumoPerc = perc(totalConsumo);
            const dfPerc = perc(totalDF);
            const moPerc = perc(totalMO);
            const impostosPerc = perc(totalImpostosTaxas);
            const liquidoPerc = perc(lucroLiquido);
            
            // Atualizar UI visível
            document.getElementById('report-receita-total').textContent = formatCurrency(totalReceitas);
            document.getElementById('report-consumo').textContent = formatCurrency(totalConsumo);
            document.getElementById('report-consumo-perc').textContent = formatPercentage(consumoPerc);
            document.getElementById('report-lucro-bruto').textContent = formatCurrency(lucroBruto);
            document.getElementById('report-despesas-fixas').textContent = formatCurrency(totalDF);
            document.getElementById('report-despesas-fixas-perc').textContent = formatPercentage(dfPerc);
            document.getElementById('report-mao-de-obra').textContent = formatCurrency(totalMO);
            document.getElementById('report-mao-de-obra-perc').textContent = formatPercentage(moPerc);
            document.getElementById('report-impostos-taxas').textContent = formatCurrency(totalImpostosTaxas);
            document.getElementById('report-impostos-taxas-perc').textContent = formatPercentage(impostosPerc);
            document.getElementById('report-lucro-liquido').textContent = formatCurrency(lucroLiquido);
            document.getElementById('report-lucro-liquido-perc').textContent = formatPercentage(liquidoPerc);
            
            document.getElementById('report-company-name-view').textContent = appState.companyInfo.name;
            document.getElementById('report-company-cnpj-view').textContent = `CNPJ: ${appState.companyInfo.cnpj}`;
            document.getElementById('report-period-view').textContent = `Período: ${periodText}`;
            document.getElementById('report-date-view').textContent = `Gerado em: ${new Date().toLocaleDateString('pt-BR')}`;
            
            // Gerar conteúdo detalhado para o PDF
            generatePdfContent(periodText, { totalReceitas, totalConsumo, lucroBruto, totalDF, totalMO, totalImpostosTaxas, lucroLiquido }, { consumoPerc, dfPerc, moPerc, impostosPerc, liquidoPerc }, { receitasFiltradas, consumoFiltrado, dfFiltrados, moFiltrados }, taxDetails);

            document.getElementById('report-output').classList.remove('hidden');
        }

        function generatePdfContent(periodText, totals, percentages, lists, taxDetails) {
            const { companyInfo, calibration } = appState;
            const detailContainer = document.getElementById('pdf-detailed-content');
            const perc = (value) => totals.totalReceitas > 0 ? (value / totals.totalReceitas * 100).toFixed(2) + '%' : '0.00%';

            const createDetailTable = (title, items, columns) => {
                if (items.length === 0) return '';
                let rows = items.map(item => `
                    <tr>
                        ${columns.map(col => `<td>${col.render(item)}</td>`).join('')}
                    </tr>
                `).join('');
                return `
                    <h3 style="font-size: 12pt; font-weight: bold; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">${title}</h3>
                    <table class="pdf-table">
                        <thead>
                            <tr>${columns.map(c => `<th>${c.header}</th>`).join('')}</tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>`;
            };
            
            const createTaxDetailTable = () => {
                 return `
                    <h3 style="font-size: 12pt; font-weight: bold; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Detalhamento de Impostos e Taxas</h3>
                    <table class="pdf-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Calibragem (%)</th>
                                <th>Valor Calculado (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Imposto sobre Faturamento</td><td>${calibration.imposto_faturamento || 0}%</td><td>${formatCurrency(taxDetails.impostoFaturamentoValor)}</td></tr>
                            <tr><td>Taxa de Débito</td><td>${calibration.taxa_debito || 0}%</td><td>${formatCurrency(taxDetails.taxaDebitoValor)}</td></tr>
                            <tr><td>Taxa de Crédito</td><td>${calibration.taxa_credito || 0}%</td><td>${formatCurrency(taxDetails.taxaCreditoValor)}</td></tr>
                            <tr><td>Comissão iFood</td><td>${calibration.comissao_ifood || 0}%</td><td>${formatCurrency(taxDetails.comissaoIfoodValor)}</td></tr>
                            <tr><td>Comissão 99</td><td>${calibration.comissao_99 || 0}%</td><td>${formatCurrency(taxDetails.comissao99Valor)}</td></tr>
                            <tr><td>Encargos Diversos</td><td>${calibration.encargos_diversos || 0}%</td><td>${formatCurrency(taxDetails.encargosDiversosValor)}</td></tr>
                            <tr style="font-weight: bold; background-color: #f2f2f2;"><td>Total</td><td></td><td>${formatCurrency(totals.totalImpostosTaxas)}</td></tr>
                        </tbody>
                    </table>
                `;
            };

            const receitaCols = [ { header: 'Data', render: item => formatDate(item.data) }, { header: 'Descrição', render: item => item.descricao || 'N/A' }, { header: 'Tipo', render: item => item.tipo }, { header: 'Valor', render: item => formatCurrency(item.valor) }];
            const despesaCols = [ { header: 'Data', render: item => formatDate(item.data) }, { header: 'Categoria', render: item => item.categoria }, { header: 'Descrição', render: item => item.descricao || 'N/A' }, { header: 'Fornecedor', render: item => item.fornecedor || 'N/A' }, { header: 'Valor', render: item => formatCurrency(item.valor) }, { header: 'Part. (%)', render: item => perc(item.valor) } ];
            
            detailContainer.innerHTML = `
                <div class="pdf-header">
                    <div>
                        <h2 style="font-size: 16pt; font-weight: bold;">${companyInfo.name}</h2>
                        <p>CNPJ: ${companyInfo.cnpj}</p>
                    </div>
                    <div style="text-align: right;">
                        <h3 style="font-size: 12pt; font-weight: bold;">Demonstração do Resultado (DRE)</h3>
                        <p>Período: ${periodText}</p>
                        <p style="font-size: 8pt;">Gerado em: ${new Date().toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>

                <h3 style="font-size: 12pt; font-weight: bold; margin-top: 20px;">Resumo Financeiro</h3>
                <table class="pdf-summary-table">
                    <tbody>
                        <tr><td>(+) Receita Bruta Total</td><td style="text-align: right; font-weight: bold;">${formatCurrency(totals.totalReceitas)}</td><td style="text-align: right; width: 80px;">100.00%</td></tr>
                        <tr><td>(-) Consumo</td><td style="text-align: right; font-weight: bold;">${formatCurrency(totals.totalConsumo)}</td><td style="text-align: right;">${formatPercentage(percentages.consumoPerc)}</td></tr>
                        <tr style="background-color: #f2f2f2;"><td>(=) Lucro Bruto</td><td style="text-align: right; font-weight: bold;">${formatCurrency(totals.lucroBruto)}</td><td></td></tr>
                        <tr><td>(-) Despesas Fixas</td><td style="text-align: right; font-weight: bold;">${formatCurrency(totals.totalDF)}</td><td style="text-align: right;">${formatPercentage(percentages.dfPerc)}</td></tr>
                        <tr><td>(-) Mão de Obra</td><td style="text-align: right; font-weight: bold;">${formatCurrency(totals.totalMO)}</td><td style="text-align: right;">${formatPercentage(percentages.moPerc)}</td></tr>
                        <tr><td>(-) Impostos e Taxas</td><td style="text-align: right; font-weight: bold;">${formatCurrency(totals.totalImpostosTaxas)}</td><td style="text-align: right;">${formatPercentage(percentages.impostosPerc)}</td></tr>
                        <tr style="background-color: #e6f7ff;"><td>(=) Lucro Líquido</td><td style="text-align: right; font-weight: bold; font-size: 11pt;">${formatCurrency(totals.lucroLiquido)}</td><td style="text-align: right; font-weight: bold;">${formatPercentage(percentages.liquidoPerc)}</td></tr>
                    </tbody>
                </table>
                
                ${createDetailTable('Detalhes das Receitas', lists.receitasFiltradas, receitaCols)}
                ${createDetailTable('Detalhes de Consumo', lists.consumoFiltrado, despesaCols)}
                ${createDetailTable('Detalhes das Despesas Fixas', lists.dfFiltrados, despesaCols)}
                ${createDetailTable('Detalhes de Mão de Obra', lists.moFiltrados, despesaCols)}
                ${createTaxDetailTable()}
            `;
        }

        async function exportPDF() {
            const reportElement = document.getElementById('pdf-detailed-content');
            if (!reportElement) return;
            reportElement.classList.remove('hidden');

            const { jsPDF } = window.jspdf;
            const canvas = await html2canvas(reportElement, { scale: 2, useCORS: true, windowWidth: reportElement.scrollWidth, windowHeight: reportElement.scrollHeight });
            
            reportElement.classList.add('hidden');
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 295; // A4 height in mm
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
              position = heightLeft - imgHeight;
              pdf.addPage();
              pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
              heightLeft -= pageHeight;
            }
            
            pdf.save(`DRE_Detalhado_${appState.companyInfo.name.replace(/ /g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
        }
        
        // ===================================================================
        // 6. EVENT LISTENERS
        // ===================================================================
        function addEventListeners() {
            companyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('company-name').value;
                const cnpj = document.getElementById('company-cnpj').value;
                if(auth.currentUser && appState.companyInfo){
                    await db.collection('empresas').doc(appState.companyInfo.id).update({ razao_social: name, cnpj });
                }
                if(name && cnpj){
                    appState.companyInfo = { ...appState.companyInfo, name, cnpj };
                    saveState(STORAGE_KEYS.COMPANY, appState.companyInfo);
                    showMainApp();
                }
            });

            logoutButton.addEventListener('click', () => {
                showConfirmationModal('Tem certeza que deseja sair?', () => { localStorage.removeItem(STORAGE_KEYS.COMPANY); auth.signOut(); });
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value);
                } catch(err){ alert(err.message); }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    razao: document.getElementById('reg-razao').value,
                    fantasia: document.getElementById('reg-fantasia').value,
                    cnpj: document.getElementById('reg-cnpj').value,
                    endereco: document.getElementById('reg-endereco').value,
                    email: document.getElementById('reg-email').value,
                    senha: document.getElementById('reg-senha').value,
                };
                try {
                    const cred = await auth.createUserWithEmailAndPassword(data.email, data.senha);
                    const empRef = await db.collection('empresas').add({ cnpj: data.cnpj, razao_social: data.razao, nome_fantasia: data.fantasia, endereco: data.endereco, status: 'aguardando', validade: '' });
                    await db.collection('usuarios').doc(cred.user.uid).set({ empresaId: empRef.id, nome: data.razao, tipo_acesso: 'admin', status: 'aguardando', validade_acesso: '' });
                    alert('Cadastro realizado. Aguarde liberação.');
                    registerForm.reset();
                    loginFormDiv.classList.remove('hidden');
                    registerFormDiv.classList.add('hidden');
                } catch(err){ alert(err.message); }
            });

            showRegister.addEventListener('click', (e)=>{ e.preventDefault(); loginFormDiv.classList.add('hidden'); registerFormDiv.classList.remove('hidden'); });
            showLogin.addEventListener('click', (e)=>{ e.preventDefault(); registerFormDiv.classList.add('hidden'); loginFormDiv.classList.remove('hidden'); });

            tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));

            document.getElementById('calibration-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newCalibration = {};
                for (let [key, value] of formData.entries()) { newCalibration[key] = value; }
                appState.calibration = newCalibration;
                saveState(STORAGE_KEYS.CALIBRATION, appState.calibration);
                alert('Calibração salva com sucesso!');
            });
            
            document.getElementById('receitas-form').addEventListener('submit', (e) => handleFormSubmit(e, 'receitas-form', STORAGE_KEYS.RECEITAS, appState.receitas));
            document.getElementById('despesas-variaveis-form').addEventListener('submit', (e) => handleFormSubmit(e, 'despesas-variaveis-form', STORAGE_KEYS.DV, appState.despesasVariaveis));
            document.getElementById('despesas-fixas-form').addEventListener('submit', (e) => handleFormSubmit(e, 'despesas-fixas-form', STORAGE_KEYS.DF, appState.despesasFixas));
            document.getElementById('mao-de-obra-form').addEventListener('submit', (e) => handleFormSubmit(e, 'mao-de-obra-form', STORAGE_KEYS.MO, appState.maoDeObra));
            
            mainApp.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) { handleDelete(e.target.dataset.id, e.target.dataset.type); }
            });

            document.getElementById('report-type').addEventListener('change', (e) => {
                const isMonthly = e.target.value === 'monthly';
                document.getElementById('month-selector-div').style.display = isMonthly ? 'block' : 'none';
                document.getElementById('year-selector-div').style.display = isMonthly ? 'none' : 'block';
            });
            
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('export-pdf-btn').addEventListener('click', exportPDF);
        }

        // ===================================================================
        // 7. PONTO DE ENTRADA DA APLICAÇÃO
        // ===================================================================
        init();
    });
    </script>
</body>
</html>
