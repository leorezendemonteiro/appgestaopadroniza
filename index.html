<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CORRETAGESTAO02 - App DRE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100">

  <!-- Tela inicial -->
  <div id="telaInicial" class="flex flex-col items-center justify-center h-screen p-4">
    <h1 class="text-2xl font-bold mb-4">üìä Padroniza DRE</h1>
    <form onsubmit="iniciarApp(); return false;" class="w-full max-w-xs">
      <input id="empresaNome" type="text" placeholder="Nome da Empresa" class="mb-2 p-2 border rounded w-full" />
      <input id="empresaCNPJ" type="text" placeholder="CNPJ" class="mb-4 p-2 border rounded w-full" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Iniciar DRE</button>
    </form>
  </div>

  <!-- Interface principal -->
  <div id="app" class="hidden p-4">
    <div class="flex gap-2 mb-4 overflow-x-auto">
      <button onclick="abrirAba('calibracao')" class="aba">Calibra√ß√£o</button>
      <button onclick="abrirAba('receitas')" class="aba">Receitas</button>
      <button onclick="abrirAba('cmv')" class="aba">CMV</button>
      <button onclick="abrirAba('fixas')" class="aba">Fixas</button>
      <button onclick="abrirAba('maoObra')" class="aba">M√£o de Obra</button>
      <button onclick="abrirAba('relatorio')" class="aba">Relat√≥rio</button>
    </div>
    <div id="conteudo"></div>
  </div>

  <script>
    const conteudo = document.getElementById("conteudo");

    function iniciarApp() {
      const nome = document.getElementById("empresaNome").value;
      const cnpj = document.getElementById("empresaCNPJ").value;
      if (!nome || !cnpj) return alert("Preencha todos os campos.");
      localStorage.setItem("empresaNome", nome);
      localStorage.setItem("empresaCNPJ", cnpj);
      document.getElementById("telaInicial").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      abrirAba("calibracao");
    }

    function abrirAba(aba) {
      const fn = {
        calibracao: renderCalibracao,
        receitas: renderReceitas,
        cmv: renderCmv,
        fixas: renderFixas,
        maoObra: renderMo,
        relatorio: renderRelatorio
      };
      fn[aba]?.();
    }

    function renderCalibracao() {
      const c = JSON.parse(localStorage.getItem("calibracao") || "{}");
      conteudo.innerHTML = `
        <h2 class="text-xl mb-4">Calibra√ß√£o</h2>
        <div class="grid gap-2">
          <input id="imp" class="input" placeholder="Imposto sobre faturamento (%)" value="${c.imp || ''}">
          <input id="deb" class="input" placeholder="Taxa de d√©bito (%)" value="${c.deb || ''}">
          <input id="cred" class="input" placeholder="Taxa de cr√©dito (%)" value="${c.cred || ''}">
          <input id="apps" class="input" placeholder="Comiss√£o de apps/iFood (%)" value="${c.apps || ''}">
          <input id="enc" class="input" placeholder="Encargos diversos" value="${c.enc || ''}">
          <button onclick="salvarCalibracao()" class="botao">Salvar Calibra√ß√£o</button>
        </div>`;
    }

    function salvarCalibracao() {
      const obj = {
        imp: +document.getElementById("imp").value,
        deb: +document.getElementById("deb").value,
        cred: +document.getElementById("cred").value,
        apps: +document.getElementById("apps").value,
        enc: +document.getElementById("enc").value
      };
      localStorage.setItem("calibracao", JSON.stringify(obj));
      alert("Salvo com sucesso!");
    }

    function renderReceitas() {
      conteudo.innerHTML = `
        <h2 class="text-xl mb-4">Receitas</h2>
        <div class="grid gap-2">
          <input id="descR" placeholder="Descri√ß√£o" class="input">
          <input id="valR" type="number" placeholder="Valor (R$)" class="input">
          <input id="dataR" type="date" class="input">
          <select id="formaR" class="input">
            <option>Cr√©dito</option><option>D√©bito</option><option>Pix</option><option>Dinheiro</option><option>iFood</option><option>99</option>
          </select>
          <button onclick="salvarReceita()" class="botao">Salvar Receita</button>
        </div>
        <div id="listaR" class="mt-4"></div>`;
      listar("receitas", "listaR");
    }

    function salvarReceita() {
      const lista = JSON.parse(localStorage.getItem("receitas") || "[]");
      lista.push({
        descricao: document.getElementById("descR").value,
        valor: +document.getElementById("valR").value,
        data: document.getElementById("dataR").value,
        forma: document.getElementById("formaR").value
      });
      localStorage.setItem("receitas", JSON.stringify(lista));
      renderReceitas();
    }

    function renderCmv() {
      conteudo.innerHTML = `
        <h2 class="text-xl mb-4">CMV</h2>
        <div class="grid gap-2">
          <select id="catC" class="input">
            <option>Alimentar</option><option>Limpeza</option><option>Descart√°veis</option><option>G√°s</option><option>Bebidas</option><option>Outros</option>
          </select>
          <input id="descC" placeholder="Descri√ß√£o" class="input">
          <input id="valC" type="number" placeholder="Valor" class="input">
          <input id="dataC" type="date" class="input">
          <input id="fornC" placeholder="Fornecedor" class="input">
          <button onclick="salvarCmv()" class="botao">Salvar Despesa Vari√°vel</button>
        </div>
        <div id="listaC" class="mt-4"></div>`;
      listar("cmv", "listaC");
    }

    function salvarCmv() {
      const lista = JSON.parse(localStorage.getItem("cmv") || "[]");
      lista.push({
        categoria: document.getElementById("catC").value,
        descricao: document.getElementById("descC").value,
        valor: +document.getElementById("valC").value,
        data: document.getElementById("dataC").value,
        fornecedor: document.getElementById("fornC").value
      });
      localStorage.setItem("cmv", JSON.stringify(lista));
      renderCmv();
    }

    function renderFixas() {
      conteudo.innerHTML = `
        <h2 class="text-xl mb-4">Despesas Fixas</h2>
        <div class="grid gap-2">
          <select id="catF" class="input">
            <option>Aluguel</option><option>IPTU</option><option>√Ågua</option><option>Energia el√©trica</option>
            <option>Internet/telefone</option><option>Software</option><option>Contabilidade</option>
            <option>Marketing</option><option>Financiamento</option><option>Pr√≥labore</option>
          </select>
          <input id="valF" type="number" placeholder="Valor" class="input">
          <input id="dataF" type="date" class="input">
          <input id="fornF" placeholder="Fornecedor" class="input">
          <button onclick="salvarFixa()" class="botao">Salvar Despesa Fixa</button>
        </div>
        <div id="listaF" class="mt-4"></div>`;
      listar("fixas", "listaF");
    }

    function salvarFixa() {
      const lista = JSON.parse(localStorage.getItem("fixas") || "[]");
      lista.push({
        categoria: document.getElementById("catF").value,
        valor: +document.getElementById("valF").value,
        data: document.getElementById("dataF").value,
        fornecedor: document.getElementById("fornF").value
      });
      localStorage.setItem("fixas", JSON.stringify(lista));
      renderFixas();
    }

    function renderMo() {
      conteudo.innerHTML = `
        <h2 class="text-xl mb-4">M√£o de Obra</h2>
        <div class="grid gap-2">
          <select id="catM" class="input">
            <option>Sal√°rios</option><option>F√©rias</option><option>Rescis√µes</option><option>INSS</option><option>FGTS</option>
            <option>Vale transporte</option><option>Vale alimenta√ß√£o</option><option>Exames</option><option>Uniformes</option>
          </select>
          <input id="valM" type="number" placeholder="Valor" class="input">
          <input id="dataM" type="date" class="input">
          <input id="fornM" placeholder="Fornecedor" class="input">
          <button onclick="salvarMo()" class="botao">Salvar M√£o de Obra</button>
        </div>
        <div id="listaM" class="mt-4"></div>`;
      listar("mao", "listaM");
    }

    function salvarMo() {
      const lista = JSON.parse(localStorage.getItem("mao") || "[]");
      lista.push({
        categoria: document.getElementById("catM").value,
        valor: +document.getElementById("valM").value,
        data: document.getElementById("dataM").value,
        fornecedor: document.getElementById("fornM").value
      });
      localStorage.setItem("mao", JSON.stringify(lista));
      renderMo();
    }

    function renderRelatorio() {
      conteudo.innerHTML = `
        <h2 class="text-xl mb-4">Relat√≥rio</h2>
        <input id="filtro" class="input mb-2" placeholder="Ex: 2025-06 ou 2025" />
        <button onclick="gerarRelatorio()" class="botao mb-4">Gerar Relat√≥rio</button>
        <div id="saidaRelatorio"></div>`;
    }

    function gerarRelatorio() {
      const filtro = document.getElementById("filtro").value;
      function filtroPorData(lista) {
        return lista.filter(x => x.data && x.data.startsWith(filtro));
      }
      const receitas = filtroPorData(JSON.parse(localStorage.getItem("receitas") || "[]"));
      const cmv = filtroPorData(JSON.parse(localStorage.getItem("cmv") || "[]"));
      const fixas = filtroPorData(JSON.parse(localStorage.getItem("fixas") || "[]"));
      const mao = filtroPorData(JSON.parse(localStorage.getItem("mao") || "[]"));
      const c = JSON.parse(localStorage.getItem("calibracao") || "{}");

      const rTot = receitas.reduce((a, b) => a + b.valor, 0);
      const cTot = cmv.reduce((a, b) => a + b.valor, 0);
      const fTot = fixas.reduce((a, b) => a + b.valor, 0);
      const mTot = mao.reduce((a, b) => a + b.valor, 0);
      const impostos = (c.imp || 0) / 100 * rTot;
      const taxas = ((c.deb || 0) + (c.cred || 0) + (c.apps || 0)) / 100 * rTot;
      const encargos = +c.enc || 0;

      const lucroBruto = rTot - cTot;
      const lucroLiquido = lucroBruto - fTot - mTot - impostos - taxas - encargos;
      const margem = rTot > 0 ? (lucroLiquido / rTot) * 100 : 0;

      document.getElementById("saidaRelatorio").innerHTML = `
        <div class="bg-white p-4 rounded shadow">
          <p><strong>Receita:</strong> R$ ${rTot.toFixed(2)}</p>
          <p><strong>CMV:</strong> R$ ${cTot.toFixed(2)}</p>
          <p><strong>Lucro Bruto:</strong> R$ ${lucroBruto.toFixed(2)}</p>
          <p><strong>Despesas Fixas:</strong> R$ ${fTot.toFixed(2)}</p>
          <p><strong>M√£o de Obra:</strong> R$ ${mTot.toFixed(2)}</p>
          <p><strong>Impostos e Taxas:</strong> R$ ${(impostos + taxas + encargos).toFixed(2)}</p>
          <p><strong>Lucro L√≠quido:</strong> R$ ${lucroLiquido.toFixed(2)}</p>
          <p><strong>Margem:</strong> ${margem.toFixed(2)}%</p>
        </div>`;
    }

    function listar(chave, destino) {
      const dados = JSON.parse(localStorage.getItem(chave) || "[]");
      document.getElementById(destino).innerHTML = dados.map((x, i) => `
        <div class="flex justify-between bg-gray-200 p-2 mb-1 rounded">
          <div><strong>${x.categoria || x.forma}</strong> - R$ ${x.valor?.toFixed(2)} - ${x.data} - ${x.descricao || x.fornecedor}</div>
          <button onclick="excluirItem('${chave}', ${i})" class="text-red-600">Excluir</button>
        </div>`).join('');
    }

    function excluirItem(chave, index) {
      const dados = JSON.parse(localStorage.getItem(chave) || "[]");
      dados.splice(index, 1);
      localStorage.setItem(chave, JSON.stringify(dados));
      abrirAba(chave === 'mao' ? 'maoObra' : chave);
    }
  </script>

  <style>
    .input { @apply p-2 border rounded w-full; }
    .botao { @apply bg-green-600 text-white px-4 py-2 rounded; }
    .aba { @apply px-4 py-2 rounded bg-gray-200 hover:bg-blue-600 hover:text-white transition; }
  </style>
</body>
</html>
